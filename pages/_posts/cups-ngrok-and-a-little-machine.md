---
title: 折腾了一下CUPS，ngrok，还有一台买了很久的占美小主机
tags: 
    - CUPS
    - Ngrok
    - 学校
categories:
    - 技术
layout: post
date: 2018-01-31 19:52:00
---

又到了折腾的时间，这一次是因为学校打印公用电脑总是各种问题。然后又一次论文打印晚了被老师一波late记过来，忍无可忍。

### 概述

学校打印机其实是可以直接联网的。网管在一台盗版的 winserver2008 上配置了 samba。但是那个其实并不是给学生用的，只是为了方便一点给公用电脑下发配置而已。更何况换了 MacBook 的我怎么可能装得了那驱动????

打印机型号是`IR-ADV 4025/4035`，128G硬盘的我瑟瑟发抖。之前就因为家里HP的打印机装了一个驱动感觉特别不爽，现在还来？不干！那能不能在另外一台机上面装一个然后远程扔`postscript`？

### 主意来了

这个时候想起之前买了一台占美的小主机（应该是这个名字，`j1900？32G emmc`，4G内存然后无线网卡什么的全部下掉。`VGA`换成了双网口+HDMI，一台下来630）。删掉里面的 win7 装了`Debian`，结果上来`Gnome`报错。听了 [@zhaofeng](https://zhaofeng.li) 的建议换了`xfce`。但是习惯命令行了无所谓。

找到之前网管给我开的特权`MAC ADDRESS`（因为学校设备都要注册mac才能上线，有规则限制，客户端之间有隔离，但是我这个mac会被分配到可以单向访问的ip段，避开了问题，~~嘿嘿嘿果然提前有人脉有资源就是好~~），改好，在ICT打印机旁边的空桌子下面找到网线口和电源。完美！然后把之前学校闲置的一台显示器搬出来试试（别问我怎么知道在哪里和他们为什么不锁柜子）。本地测试基本完成。

接下来就是调整`CUPS`，打开 Web 界面然后添加。`discover` 里面直接跳出两台打印机，完美！但是`Canon`列表里面没有想要的驱动

有毒。万一要是没有给Linux版的驱动那不就白高兴Orz

上官网找，canon你这网站是外包吧怎么下载页面指向的是循环页面。无奈只能关键词谷歌搜索，换了几个关键词在Debian CUPS的PDD说明里面找到了。一共给了三个下载链接，狂喜！然后cn的网站和us的全部是空链接，~~佳能你这剧毒哦~~，但是最后uk的链接居然可以下载（但是下载页面居然是文本）！100M的包挂着网易蜂巢的网很快弄下载（网易这百兆国外资源跑满，国内只有10兆，不过还行，S3下载神器。但是我的旧版套餐就要下架了）。跑起来没毛病，各种自定义选项均可以用。

### 小小的研究

因为有两台打印机，就想着能不能一次就添加完，找到了打印池（class），把两台打印机加到一个class然后添加一次class就好。作业会平均分配，还行。不过就是不知道会从哪个打印机出来。也没什么，到打印机面前看一下任务就知道了，倒是不算什么

我后面还是没有加Samba在服务器上自动分发Windows驱动，第一是因为内置了，而且Samba在这个时间出了很多问题，内网环境也不是很好布置（单向），还有就是通用驱动都可以用为什么我还要那么麻烦????，不服请买苹果。

写完以后做了一个小教程扔到微信上，把内网IP绑在了域名上。主要是怕后面内网变动IP变了结果连不上。到时候就直接换解析方便一点。蛮多人在用，作业一天有几十个，完成收工。

### 然后就没有了？

不不不当然还是要写一下坑的：

1.  我也不知道是怎么弄得，CUPS都可以局域网访问了但是外网（对就是ngrok）总是bad request。配置文件设置了HOST改了重启了还是没用。迫不得已只能用squid做了一个反向代理
2.  在MacBook上添加IPP打印机，那个队列是整个地址去掉域名的部分（就是有点像 get 请求那样，扶额），我一开始怎么都加不上打印机简直崩溃，查了一下才知道是这样的。然后就是地址他一定会链接631端口。真的GG，现在我的ngrok还不能支持远程打印就是这个奇葩的原因。谁说就一定631了我直接映射80不行吗学学Windows好不好扔个地址就好了。
3.  这里又不得不吐槽一下Windows的问题（或者说我真的是找不到怎么做了），Mac上添加打印机就是会一个是否有双面打印单元的选项，但是Windows上的generic驱动 imagesetter和color printer都不支持双面打印。唯一就是选择正确的驱动了，还好Windows 10内置了那款打印机的驱动。
4.  还有个小问题就是打印大文件有几率会丢/卡，初步怀疑是网络问题但是还没有确定

### 关于Ngrok

用的是免费的 ngrok.cc ，感觉很稳定没什么问题就用这免费的了。手里面有两个账号但是有一个连注册的邮箱都忘记了只有clientid，能用????，之前设置了就是用来做ssh转发没毛病。另外一个就把squid反向代理放出去了。但是Mac不支持（GG）Windows可以用。也就放在那里了。没有上HTTPS什么的因为没什么时间管，而且大部分时间都是连进内网打印。外网的有需要再好好做吧233。打印权限没管，但是学校本来也不限制这个所以也没做。等 NoticeBoard 做成型了在整合也来得及。后面想的是用 anyconnect 做一个接入校园内网的 VPN（学校对等宽带有多余ip），以后有机会还可以托管个NAS在学校电费网费都省了23333

不过都是后话了，配置文件图片什么的有机会再补（估计是不会填坑了????，除非有人催）

