(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{160:function(t,s,a){"use strict";a.r(s);var e=a(0),n=function(t){var s,a,e,n,r,p,l,o,i,c=(e=void 0,n="Shadowsocks",r="基本原理",p="实现方法",l="安装并启动ss-redir",o="配置iptables实现流量的转发",i="配置实现流量的选择性代理",(s={}).type=a="post",s.internal=e,s.contentType="markdown",s.slug="build-a-rediretcor-with-ss-redir",s.content=e,s.createdAt=new Date(15365997e5),s.updatedAt=new Date(1610680508197),s.title="利用ss-redir做国内中转节点",s.tags=[n,"中转","教程"],s.categories=["技术"],s.layout=a,s.date="2018-09-11 01:15:00",s.markdownHeadings=[{text:r,slug:r,level:1},{text:p,slug:p,level:1},{text:l,slug:l,level:2},{text:o,slug:o,level:2},{text:i,slug:i,level:2},{text:"清理 iptables",slug:"清理-iptables",level:2}],s.excerpt="<p><strong>大部分搬运内容，实测可用</strong></p>\n",s.permalink="/2018/09/11/build-a-rediretcor-with-ss-redir",s.assets={},s.attributes=s,s.tagsInfo=[{name:n,permalink:"/blog/tag/shadowsocks"},{name:"中转",permalink:"/blog/tag/中转"},{name:"教程",permalink:"/blog/tag/教程"}],s.categoriesInfo=[{name:"技术",permalink:"/blog/category/technology"}],s),v=t.options.beforeCreate||[];t.options.beforeCreate=[function(){this.$page=c}].concat(v);["layout","transition"].forEach((function(s){var a=t.options.PageComponent;a&&(t.options[s]=a[s]),void 0===t.options[s]&&(t.options[s]=c[s])})),c.slug&&(t.options.name="page-wrapper-"+c.slug.replace(/[^0-9a-z\-]/gi,"-"))},r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("layout-manager",[a("p",[a("strong",[t._v("大部分搬运内容，实测可用")])]),t._v(" "),a("h1",{attrs:{id:"基本原理"}},[a("saber-link",{attrs:{title:"基本原理",to:"#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"}}),t._v("基本原理")],1),t._v(" "),a("p",[t._v("首先ss-redir会在本地创建一个TCP透明代理，因此我们只需要将我们需要代理的流量重定向到 ss-redir的监听端口上即可。 对于流量的重定向，我们可以使用iptables中nat表的REDIRECT来实现。 而对于流量的筛选，我们同样可以利用iptables根据一个国内IP地址表来筛选出不需要代理的IP。")]),t._v(" "),a("h1",{attrs:{id:"实现方法"}},[a("saber-link",{attrs:{title:"实现方法",to:"#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"}}),t._v("实现方法")],1),t._v(" "),a("h2",{attrs:{id:"安装并启动ss-redir"}},[a("saber-link",{attrs:{title:"安装并启动ss-redir",to:"#%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8ss-redir"}}),t._v("安装并启动ss-redir")],1),t._v(" "),a("p",[t._v("安装和启动的方法本文不再介绍。 此处需要注意ss-redir本地监听端口需要跟后面iptables中配置的重定向端口对应， 本文假设ss-redir监听端口为"),a("code",{pre:!0},[t._v("1081")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"配置iptables实现流量的转发"}},[a("saber-link",{attrs:{title:"配置iptables实现流量的转发",to:"#%E9%85%8D%E7%BD%AEiptables%E5%AE%9E%E7%8E%B0%E6%B5%81%E9%87%8F%E7%9A%84%E8%BD%AC%E5%8F%91"}}),t._v("配置iptables实现流量的转发")],1),t._v(" "),a("p",[t._v("首先需要在iptables的nat表中创建一个专门用于处理代理的chain：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ iptables -t nat -N SHADOWSOCKS")])])]),a("p",[t._v("在刚刚创建的chain中，首先需要增加一条规则来跳过对SS服务器流量的处理：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ iptables -t nat -A SHADOWSOCKS -d YOUR_SS_IP -m comment --comment "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Bypass SS server traffic"')]),t._v("-j RETURN")])])]),a("p",[t._v("接下来利用ipset工具创建一个局域网子网列表，并添加一条规则用来跳过局域网流量：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ ipset create sslans hash:net\n\n$ ipset "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" sslans "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/8\n\n$ ipset "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" sslans "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0.0/8\n\n$ ipset "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" sslans "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.0/8\n\n$ ipset "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" sslans "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.16")]),t._v(".0.0/12\n\n$ ipset "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" sslans "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.0/16\n\n$ iptables -t nat -A SHADOWSOCKS -m "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" --match-set sslans dst -m comment --comment "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Bypass LANs"')]),t._v(" -j RETURN")])])]),a("p",[t._v("最后添加一条规则将还未匹配到的流量转发至ss-redir的端口上， 同时在OUTPUT chain中增加SHADOWSOCKS chain的规则：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-ports "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1081")]),t._v("\n\n$ iptables -t nat -A OUTPUT -o eth0 -p tcp -j SHADOWSOCKS")])])]),a("p",[t._v("此时本机所有的流量都应该会被代理进行转发，可以使用以下命令来测试出口IP：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://www.ip168.com/json.do?view=myipaddress"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -Po "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"([0-9]{1,3}\\.?){4}"')])])])]),a("h2",{attrs:{id:"配置实现流量的选择性代理"}},[t._v("配置实现流量的选择性代理")]),t._v(" "),a("p",[t._v("首先需要拿到所有的国内IP地址，这里使用一个"),a("code",{pre:!0},[t._v("bestroutetb")]),t._v("工具实现， 可以使用"),a("code",{pre:!0},[t._v("npm install -g bestroutetb")]),t._v("安装该工具。 该工具会从apnic下载IP数据并生成一个路由表，我们将其中的国内IP部分提取出来并添加到ipset中。")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ bestroutetb -p custom --rule-format"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%prefix/%length"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\n         --group-header"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("---%name-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("' --group-footer=---%name-end"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\n         --group-gateway -f -o /tmp/chnroutes.txt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/---vpn-start/,/---vpn-end/d'")]),t._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/^---/d'")]),t._v(" /tmp/chnroutes.txt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /tmp/tb.txt\n         \n$ ipset create chnroute hash:net\n\n$ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("read")]),t._v(" rule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ipset "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" chnroute "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$rule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" /tmp/tb.txt")])])]),a("p",[t._v("最后在SHADOWSOCKS chain的REDIRECT规则之前插入一条针对国内IP的跳过规则：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":""}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-text"}},[a("code",{pre:!0,attrs:{class:"language-text"}},[t._v('$ iptables -t nat -I SHADOWSOCKS 3 -m set --match-set chnroute dst -m comment --comment "Bypass China IPs" -j RETURN')])])]),a("p",[t._v("可以用国内和国外两个不同的站点来验证选择性代理是否正确：")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://api.ipify.org?format=json"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -Po "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"([0-9]{1,3}\\.?){4}"')]),t._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://www.ip168.com/json.do?view=myipaddress"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -Po "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"([0-9]{1,3}\\.?){4}"')])])])]),a("h2",{attrs:{id:"清理-iptables"}},[t._v("清理 iptables")]),t._v(" "),a("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"bash"}},[a("pre",{pre:!0,attrs:{class:"saber-highlight-code language-bash"}},[a("code",{pre:!0,attrs:{class:"language-bash"}},[t._v("iptables -F\niptables -X\niptables -t nat -F\niptables -t nat -X\niptables -t mangle -F\niptables -t mangle -X\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT")])])])])}),[],!1,null,null,null);"function"==typeof n&&n(r);s.default=r.exports}}]);