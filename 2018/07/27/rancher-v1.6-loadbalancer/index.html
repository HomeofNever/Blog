<!DOCTYPE html><html data-saber-ssr lang="zh-CN" class="serif" data-saber-head="%7B%22lang%22:%7B%22ssr%22:%22zh-CN%22%7D,%22class%22:%7B%22ssr%22:%22serif%22%7D%7D"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.6"><meta data-saber-head="ssr" name="author" content="NeverBehave"><meta data-saber-head="ssr" property="og:type" content="website"><meta data-saber-head="ssr" property="og:image" content="https://blog.never.pet/icons/android-chrome-512x512.png"><meta data-saber-head="ssr" name="twitter:card" content="summary"><meta data-saber-head="ssr" name="twitter:site" content="_NeverBehave_"><meta data-saber-head="ssr" name="twitter:image" content="https://blog.never.pet/icons/android-chrome-512x512.png"><meta data-saber-head="ssr" name="twitter:creator" content="NeverBehave"><meta data-saber-head="ssr" name="description" content="迷の生物的迷の小窝" data-hid="description"><meta data-saber-head="ssr" name="keywords" content="undefined,,,,,,"><meta data-saber-head="ssr" property="og:title" content="Rancher v1.6 负载均衡折腾小记"><meta data-saber-head="ssr" property="og:description" content="迷の生物的迷の小窝"><meta data-saber-head="ssr" name="twitter:title" content="Rancher v1.6 负载均衡折腾小记"><meta data-saber-head="ssr" name="twitter:description" content="迷の生物的迷の小窝"> <title>Rancher v1.6 负载均衡折腾小记 - Never迷の小窝</title> <link data-saber-head="ssr" rel="manifest" href="/manifest.json"><link data-saber-head="ssr" rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png"><link data-saber-head="ssr" rel="alternate" title="Never迷の小窝 - Feed" href="https://blog.never.pet/feed/atom.xml" type="application/atom+xml"><link data-saber-head="ssr" href="https://cdn.jsdelivr.net/" rel="preconnect" crossorigin="true"><style data-vue-ssr-id="44ad3bfa:0 c371470e:0 4cf09be2:0 72951a42:0 6a678705:0">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}
.blendIn_16__k[data-src],.blendIn_16__k[data-srcset]{transition:filter .3s;filter:blur(5px)}.blendIn_16__k[data-lazy-loaded]{filter:none}
blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,ol,p,pre,ul{margin:0;padding:0}body{font:400 16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}blockquote,dl,figure,h1,h2,h3,h4,h5,h6,ol,p,pre,ul{margin-bottom:15px}main{display:block}img{max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:14px}ol,ul{margin-left:30px}li>ol,li>ul{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:700}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}code,pre{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:770px;margin-right:auto;margin-left:auto;padding-right:15px;padding-left:15px}@media screen and (min-width:800px){.wrapper{max-width:740px;padding-right:30px;padding-left:30px}}.footer-col-wrapper:after,.wrapper:after{content:"";display:table;clear:both}.orange{color:#f66a0a}.grey{color:#828282}.svg-icon{width:16px;height:16px;display:inline-block;fill:currentColor;padding:5px 3px 2px 5px;vertical-align:text-bottom}table{margin-bottom:30px;width:100%;text-align:left;color:#3f3f3f;border-collapse:collapse;border:1px solid #e8e8e8}table tr:nth-child(2n){background-color:#f7f7f7}table td,table th{padding:10px 15px}table th{background-color:#f0f0f0;border:1px solid #dedede;border-bottom-color:#c9c9c9}table td{border:1px solid #e8e8e8}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:55.95px;line-height:54px;position:relative}.site-title{font-size:26px;font-weight:300;letter-spacing:-1px;margin-bottom:0;float:left}@media screen and (max-width:600px){.site-title{padding-right:45px}}.site-title,.site-title:visited{color:#424242}.site-nav{position:absolute;top:9px;right:15px;background-color:#fdfdfd;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg path{fill:#424242}.site-nav label[for=nav-trigger]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav input~.trigger{clear:both;display:none}.site-nav input:checked~.trigger{display:block;padding-bottom:5px}.site-nav .page-link{color:#111;line-height:1.5;display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}@media screen and (min-width:600px){.site-nav{position:static;float:right;border:none;background-color:inherit}.site-nav .menu-icon,.site-nav label[for=nav-trigger]{display:none}.site-nav input~.trigger{display:block}.site-nav .page-link{display:inline;padding:0;margin-left:auto}.site-nav .page-link:not(:last-child){margin-right:20px}}.pagination{margin-bottom:25px;font-size:.875rem}.pagination .next-link,.pagination .prev-link{border:1px solid #e8e8e8;padding:5px 10px;color:#111}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{width:-webkit-calc(100% - 15px);width:calc(100% - 15px);margin-bottom:15px;padding-left:15px}.footer-col-1,.footer-col-2{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}.footer-col-3{width:-webkit-calc(100% - 15px);width:calc(100% - 15px)}@media screen and (min-width:800px){.footer-col-1{width:-webkit-calc(35% - 15px);width:calc(35% - 15px)}.footer-col-2{width:-webkit-calc(20% - 15px);width:calc(20% - 15px)}.footer-col-3{width:-webkit-calc(45% - 15px);width:calc(45% - 15px)}}@media screen and (min-width:600px){.footer-col{float:left}}.page-content{padding:30px 0;flex:1 0 auto}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-content h1,.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (min-width:800px){.post-content h1,.post-title{font-size:42px}}.post-content{margin-bottom:30px}.post-content h2{font-size:28px}@media screen and (min-width:800px){.post-content h2{font-size:32px}}.post-content h3{font-size:22px}@media screen and (min-width:800px){.post-content h3{font-size:26px}}.post-content h4{font-size:18px}@media screen and (min-width:800px){.post-content h4{font-size:20px}}.social-media-list{display:table;margin:0 auto}.social-media-list li{float:left;margin:0 5px}.social-media-list li:first-of-type{margin-left:0}.social-media-list li:last-of-type{margin-right:0}.social-media-list li a{display:block;padding:7.5px;border:1px solid #e8e8e8}.social-media-list li:hover .svg-icon{fill:currentColor}.one-half{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}
.saber-highlight{position:relative;overflow:hidden;margin:2rem 0;background:#f5f7fa;border-radius:4px}.saber-highlight:before{content:attr(data-lang);position:absolute;right:10px;top:5px;font-size:.75rem;color:#bdc5d1}.saber-highlight-code,.saber-highlight-mask{line-height:1.5;background-color:transparent!important;text-shadow:none!important;box-shadow:none!important;margin:0!important;padding:1.25rem 1.5rem!important;white-space:pre}.saber-highlight-mask{position:absolute;top:0;bottom:0;left:0;right:0;z-index:1;color:transparent!important;padding-left:0!important;padding-right:0!important}.saber-highlight-code{position:relative;z-index:2;font-size:0!important}.saber-highlight-code code,.saber-highlight-mask{font-size:.875rem}.code-line.highlighted{background:rgba(3,169,244,.121)}.saber-highlight-line-numbers{pointer-events:none;font-size:100%;float:left;letter-spacing:-1px;border-right:1px solid #999;user-select:none;text-align:right;padding-right:.8rem;margin-right:.8rem}.saber-highlight-line-numbers>span{counter-increment:linenumber;display:block}.saber-highlight-line-numbers>span:before{content:counter(linenumber);color:#999;display:block}
.post-end[data-v-68f7aa60]{position:relative;margin:3rem 0;color:#ddd;border-bottom:.2em dashed #ddd}</style>  </head><body><div id="_saber" data-server-rendered="true"><div data-v-68f7aa60><header class="site-header"><div class="wrapper"><a href="/" rel="author" class="site-title router-link-active">Never迷の小窝</a> <nav class="site-nav"><input type="checkbox" id="nav-trigger" class="nav-trigger"> <label for="nav-trigger"><span class="menu-icon"><svg viewBox="0 0 18 15" width="18px" height="15px"><path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path></svg></span></label> <div class="trigger"><a href="/" class="page-link router-link-active">Home</a><a href="/about" class="page-link">About</a><a rel="noopener noreferrer" target="_blank" href="https://never.pet" class="page-link">Social</a><a href="/friends" class="page-link">Friends</a></div></nav></div></header> <main aria-label="Content" class="page-content"><div class="wrapper"><article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" class="post h-entry" data-v-68f7aa60><header class="post-header" data-v-68f7aa60><h1 itemprop="name headline" class="post-title p-name" data-v-68f7aa60>Rancher v1.6 负载均衡折腾小记</h1> <div align="left" class="post-meta" data-v-68f7aa60><time datetime="Fri Jul 27 2018 07:28:00 GMT+0800 (China Standard Time)" itemprop="datePublished" class="dt-published" style="display:inline-block;" data-v-68f7aa60>07/27/2018</time> <section class="page-categories" data-v-68f7aa60><span data-v-68f7aa60><!----> <a href="/blog/category/technology" class="category" data-v-68f7aa60>技术</a></span></section> <section class="page-block-action" data-v-68f7aa60><div class="page-share" data-v-68f7aa60></div> <div class="page-tags" data-v-68f7aa60><span data-v-68f7aa60><!----> <span class="tag" data-v-68f7aa60>折腾</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>Elastic Search</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>Kibana</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>Rancher</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>Docker</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>负载均衡</span></span></div></section></div> <div data-v-68f7aa60><p><span>书写于 4 年前</span> <!----></p> <strong>注意: 这篇文章已经有相当一段时间没有更新了. <br> 文章中任何有时效性的信息应当在仔细审阅后再使用. <br> 如果有任何更新建议, 请留言. </strong></div></header> <div itemprop="articleBody" class="post-content e-content" data-v-68f7aa60><h2 id="前言">前言</h2> <p><strong>包含了两个内容，一个是加日志，另外一个是H2</strong></p> <p>之前看 <a rel="noopener noreferrer" target="_blank" href="https://blog.indexyz.me">@indexyz</a> 做了一下 ELK（Elastic Search，Logstash，Kibana）给 Nginx 记录日志，感觉 <a rel="noopener noreferrer" target="_blank" href="https://www.elastic.co/products/kibana">Kibana</a> 看日志的效果真的还可以，便打算给自己的 Rancher 均衡负载做一个。然而……</p> <h2 id="rancher-的均衡负载">Rancher 的均衡负载</h2> <p>这玩意本身限制蛮多，首先是你要合并进配置的话……你不能直接改配置文件，他自己有一套管理而且 Rancher-LB 的<code>Dockerfile</code>是没有公开的。</p> <p>我一直以为他的自定义cfg文件只能合并进<code>defaults</code>直到我看到了重新<a rel="noopener noreferrer" target="_blank" href="https://rancher.com/docs/rancher/v1.6/zh/cattle/adding-load-balancers/">这里</a><s>！！下次看文档仔细一点啊喂！！</s>:</p> <figure><img alt="" data-lazy="{}" src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/a9f190abee49be4420c6a2ff22c67d2c-959.jpg" srcset="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx4BBQUFBwYHDggIDh4UERQeHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHv/AABEIABQAKAMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AOw+L3xa8XeHfiFrelabLDHa2kqKmIS5wYlbnDjHJNbwgmrnLUqyjJpHGL+0b8SFUAS6VgDHNpn/ANmq/ZRM/rExf+GjviT/AM9dJ/8AAP8A+vR7GIfWJh/w0d8Sf+euk/8AgH/9ej2MQ+sTOr+EPxw8c+J/iRo2g6pJpxs7yVklEdttbARjwc8cgVM6cUrl060pSSZxXx/jZ/i/4l8piH+0RdJCv/LFPQ+ntVU/hRnV+Nnl0ltMJGCwyEZ4IUn+laGRHJHJGQJEZM9NwxQIbQB6B+zp/wAlq8Nf9fD/APop6ip8LNaPxo9V+LXg7S7/AOI+s38012JZpEZgrqBxGo/u+1Zwk0japBOTZx8/w60SWPY11qeM5/14P81xVc7I9miD/hWGgf8AP3qf/fxP/iKOdi9kg/4VhoH/AD96n/38T/4ijnYeyR1nwf8AAOj6T8SdG1G3ub95YZWZRI6FT8jDnCj1qZzbRdOmlJM//9k=" data-srcset="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/a9f190abee49be4420c6a2ff22c67d2c-959.jpg 959w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/dd9082612b00ec15ceffb4dda083218c-720.jpg 720w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/c5085068007505f19286f94d625f1871-480.jpg 480w" width="959"></figure> <p>原来是可以分块添加的，完美。</p> <h2 id="haproxy">Haproxy</h2> <p>既然是 Haproxy 做的，那就看看 Haproxy 能够怎么记录日志吧</p> <h3 id="redis">Redis</h3> <p>Indexyz 用了 Redis 做中继（日志丢进Redis，然后 Logstash 从里面读取），这样子防止 Logstash 爆炸丢日志（最佳实践）。我的话……懒一点</p> <h3 id="syslog">Syslog</h3> <p>本身 Haproxy 有<a rel="noopener noreferrer" target="_blank" href="https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#log%20global">向远程服务器丢日志</a>的功能。然后里面是支持 Syslog 的。完美！那就直接丢吧！ Logstash 也是原生支持！</p> <h4 id="rancher-dns">Rancher DNS</h4> <p>诶等一下，我没有链接容器怎么办？难道每个配置文件里面都要手动写IP？其实每个服务容器都自动注册了一个唯一的地址，<a rel="noopener noreferrer" target="_blank" href="https://rancher.com/docs/rancher/v1.6/zh/cattle/internal-dns-service/#ping-1">看这里</a></p> <h3 id="配置文件例子">配置文件例子</h3> <div class="saber-highlight" data-lang=""><pre class="saber-highlight-code language-text"><code class="language-text">defaults
    mode http
    option tcp-smart-accept
    option tcp-smart-connect
    log logstash.elk:5000 len 65535 syslog
    log-format '{&quot;STATUS&quot;: &quot;%ST&quot;,&quot;Host&quot;: &quot;%[capture.req.hdr(0),json(utf8s)]&quot;,&quot;REQ_IP&quot;: &quot;%ci&quot;,&quot;CF-Connecting&quot;: &quot;%[capture.req.hdr(2),json(utf8s)]&quot;,&quot;CF-COUNTRY&quot;: &quot;%[capture.req.hdr(1),json(utf8s)]&quot;,&quot;HTTP_VERSION&quot;:&quot;%HV&quot;,&quot;SSL_VERSION&quot;: &quot;%sslv&quot;,&quot;URL&quot;: &quot;%HU&quot;,&quot;REFERER&quot;: &quot;%[capture.req.hdr(4),json(utf8s)]&quot;,&quot;USER_AGENT&quot;: &quot;%[capture.req.hdr(5),json(utf8s)]&quot;,&quot;LANGUAGE&quot;: &quot;%[capture.req.hdr(3),json(utf8s)]&quot;,&quot;METHOD&quot;: &quot;%HM&quot;,&quot;REQ_TIME&quot;: &quot;%Tq&quot;}'

frontend 443
  mode http
  capture request header Host len 40
  capture request header CF-IPCountry len 20
  capture request header CF-Connecting-IP len 50
  capture request header Accept-Language len 50
  capture request header Referer len 200
  capture request header User-Agent len 200

frontend 80
  capture request header Host len 40
  capture request header X-Forwarded-For len 50
  capture request header Accept-Language len 50
  capture request header Referer len 200
  capture request header User-Agent len 200</code></pre></div><h4 id="关于capture">关于Capture</h4> <ol><li><code>IPCountry</code> 需要自己设定在 Cloudflare 设置 <code>Page Rule</code>，不过呢，Logstash 本身也有这个功能：<img alt="" data-lazy="{}" src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/f9a24606e0357bddb4d0696c58abafe4-282.jpg" srcset="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx4BBQUFBwYHDggIDh4UERQeHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHv/AABEIABYAKAMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APkey1RzE8V5E9xbhANsYRCvIwd20/T8adxkd5b2kn7+PUbXcwLMmJC2Sc4+4Bn6ccUCI4bK2kVi2q2kRVsAOsvzD1GEP64osBFf28VtN5cV5BdjHLwhtv8A48Af0pAV6AJbed4Q4UId67TuQNx7Z7+9AG752nXcfkLHHbyBULNLHFGD64wucnNVoMrC5aNnVhpEnmHkmAHG70+XjGPwpAQX1mMlze6dkLkiFj7+1AGbSESMUXcqDcGUDLDkHgnH+elADGZmOWJJ6ZJoASgAoAKAP//Z" data-srcset="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/f9a24606e0357bddb4d0696c58abafe4-282.jpg 282w" width="282"></li> <li>因为 Haproxy 本身呢……如果你要记录 Header 你必须要自己现在 Frontend 里面加上。这个的话就是看自己需要什么了。</li></ol> <p>参考资料：</p> <ul><li><a rel="noopener noreferrer" target="_blank" href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/haproxy">https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/haproxy</a></li> <li><a rel="noopener noreferrer" target="_blank" href="https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#8.2.4">https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#8.2.4</a></li></ul> <h2 id="elk">ELK</h2> <p>这里就直接上 Docker-compose</p> <div class="saber-highlight" data-lang=""><pre class="saber-highlight-code language-text"><code class="language-text">version: '2'
services:
  Kibana:
    image: docker.elastic.co/kibana/kibana:6.3.1
    environment:
      ELASTICSEARCH_URL: http://elasticsearch:9200
    stdin_open: true
    tty: true
    links:
    - Elasticsearch:elasticsearch
    labels:
      io.rancher.container.pull_image: always
  Elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.3.1
    environment:
      discovery.type: single-node
    stdin_open: true
    volumes:
    - /data/elk/elasticsearch:/usr/share/elasticsearch/data
    tty: true
    labels:
      io.rancher.container.pull_image: always
  Logstash:
    image: docker.elastic.co/logstash/logstash:6.3.1
    stdin_open: true
    volumes:
    - /data/elk/logstash/:/usr/share/logstash/pipeline/
    tty: true
    links:
    - Elasticsearch:elasticsearch
    labels:
      io.rancher.container.pull_image: always</code></pre></div><ul><li>因为是 bind mount，记得给权限<code>chown 1000:1000</code></li> <li>Logstash 没有配置文件会启动失败，配置文件名是<code>logstash.conf</code></li> <li><code>Kibana</code>的 Web 端口是<code>5601</code></li></ul> <h2 id="logstash">Logstash</h2> <p>先放配置文件：</p> <div class="saber-highlight" data-lang=""><pre class="saber-highlight-code language-text"><code class="language-text">input {
  udp {
    port =&gt; 5000
    type =&gt; syslog
  }

  tcp {
    port =&gt; 5000
    type =&gt; syslog
  }
}

filter {
  grok {
    match =&gt; {&quot;message&quot; =&gt; &quot;&lt;%{NUMBER}&gt;%{SYSLOGTIMESTAMP} %{SYSLOGPROG}: %{GREEDYDATA:message}&quot;}
    overwrite =&gt; [&quot;message&quot;]
  }
  json {
    source =&gt; &quot;message&quot;
    remove_field =&gt; [&quot;message&quot;]
  }
}

output {
  elasticsearch { hosts =&gt; [&quot;elasticsearch:9200&quot;] }
  stdout { codec =&gt; rubydebug }
}</code></pre></div><ul><li><code>grok</code> 是因为 Haproxy 本身会遵守规则在里面有一段 SYSLOG 的前缀，JSON Parse 之前要先剔除</li> <li>注意下 Logstash 各个版本版本语法变化很多，每次都因为看旧的例子被坑到（比如<code>match</code>，以前是数组）。参考资料尽量看官方，或者<strong>一定要注意回复时间</strong></li></ul> <p>这样子出来以后的效果如图：</p> <p><img alt="" data-lazy="{}" src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/af445e998204e2b50d86b44d6c58c8a0-1031.jpg" srcset="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx4BBQUFBwYHDggIDh4UERQeHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHv/AABEIAAYAKAMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APsd4UY5Jf8AByP5GgDI1eX7NcAiSYALgAOep9eaBFbzp4sxmeVtsZfJck4FAAZ5nHEsgUjfzI3Gc4HWhgWNK+33DK73APlkb+SAxyeg7dD60knbXcbtfQ//2Q==" data-srcset="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/af445e998204e2b50d86b44d6c58c8a0-1031.jpg 1031w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/2e519be50e9d2270cf0b95564d868b6c-720.jpg 720w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/76eb5fac561251f5826501c2cf275f57-480.jpg 480w" width="1031"> <img alt="" data-lazy="{}" src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/983ca04601d29dc68b0eaadca77d5cc0-249.jpg" srcset="data:image/jpeg;base64,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" data-srcset="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/983ca04601d29dc68b0eaadca77d5cc0-249.jpg 249w" width="249"></p> <p>更多的话就让大家自己去摸索啦</p> <h2 id="还有些什么没做呢">还有些什么没做呢</h2> <p>Haproxy 启动的日志我没处理，这个时候就会有<code>_jsonparsefailure</code>标签，有兴趣的自己写一下吧</p> <h2 id="关于-h2">关于 H2</h2> <p>因为 Cloudflare 默认上传只有 100M ，这……网盘可以直接GG了。然而如果直接把 Haproxy 放在前面那就要尽可能多做点优化啦。比如说 http2</p> <h3 id="然而">然而</h3> <p>Bind 指令是Rancher自己生成的！如果你要启动 http2 必须要在 Bind 后面加上选项 <a rel="noopener noreferrer" target="_blank" href="https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#5.1-alpn">alpn</a></p> <p>你说那我可以自己构造覆盖？但是证书是Rancher部分管理的，除非你打算自己写文件名（也不是不行）。</p> <p>直接覆盖文件不要想，前面说过rancher每次启动容器都会覆盖掉这个部分。</p> <h2 id="关于-rancher-lb">关于 Rancher-lb</h2> <p>在查资料的时候发现 Rancher v1.6 默认使用的 Load Balancer 镜像使用的 Haproxy 是有漏洞的（1.8.x)。还是一个<code>Crit</code>级别（需要开启h2，所以没有推送更新？）。虽然官方已经有更新版本了但是默认 Rancher 会锁死版本号（GG）所以不会更新</p> <p>这个时候就要自己去<code>系统管理-&gt;系统设置-&gt;高级设置</code>里面改使用的版本
<img alt="" data-lazy="{}" src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/67b563153d795a3ff4df92b25f9e0e70-1200.jpg" srcset="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx4BBQUFBwYHDggIDh4UERQeHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHv/AABEIAAIAKAMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APDFdvsMrbjkSIAc+zVLf7xLyf6Er4G/NfqZ7yysuGkcj0LGrAjyfU0gDJ9TQA+EnzOp6H+VTLYaP//Z" data-srcset="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/67b563153d795a3ff4df92b25f9e0e70-1200.jpg 1200w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/870cf364652f87f8bc2efb354c14f4c6-720.jpg 720w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/f8b8dbde29353bc20d1c73a9eedd6361-480.jpg 480w" width="1200"></p> <p>最新的 Rancher-lb 版本截至目前是<code>0.9.4</code>可以在这里查看<a rel="noopener noreferrer" target="_blank" href="https://hub.docker.com/r/rancher/lb-service-haproxy/tags/">最新地址</a></p> <p>改完以后记得去升级（会有提示）</p></div> <div class="post-end" data-v-68f7aa60>The end is not the end; Je vous laisse.</div> <section data-v-68f7aa60><div id="disqus_thread"></div></section> <a href="/2018/07/27/rancher-v1.6-loadbalancer" hidden="hidden" class="u-url router-link-exact-active router-link-active" data-v-68f7aa60></a></article></div></main> <footer class="site-footer h-card"><div class="wrapper"><div class="footer-col-wrapper"><div class="footer-col one-half"><h2 class="footer-heading">Never迷の小窝</h2> <ul class="contact-list"><li class="p-name">NeverBehave</li> <li><a href="mailto:i@never.pet" class="u-email">i@never.pet</a></li></ul></div> <div class="footer-col one-half"><p>迷の生物的迷の小窝</p></div> <div class="social-links"></div></div></div></footer></div></div><script src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/js/client.50fb4dd0.js" defer></script><script src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/js/page--_posts-rancher-v1-6-loadbalancer-md.b23abb06.js" defer></script></body></html>
