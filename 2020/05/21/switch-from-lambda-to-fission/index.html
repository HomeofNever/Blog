<!DOCTYPE html><html data-saber-ssr lang="zh-CN" class="serif" data-saber-head="%7B%22lang%22:%7B%22ssr%22:%22zh-CN%22%7D,%22class%22:%7B%22ssr%22:%22serif%22%7D%7D"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.6"><meta data-saber-head="ssr" name="author" content="NeverBehave"><meta data-saber-head="ssr" property="og:type" content="website"><meta data-saber-head="ssr" property="og:image" content="https://blog.never.pet/icons/android-chrome-512x512.png"><meta data-saber-head="ssr" name="twitter:card" content="summary"><meta data-saber-head="ssr" name="twitter:site" content="_NeverBehave_"><meta data-saber-head="ssr" name="twitter:image" content="https://blog.never.pet/icons/android-chrome-512x512.png"><meta data-saber-head="ssr" name="twitter:creator" content="NeverBehave"><meta data-saber-head="ssr" name="description" content="迷の生物的迷の小窝" data-hid="description"><meta data-saber-head="ssr" name="keywords" content="undefined,,,,,"><meta data-saber-head="ssr" property="og:title" content="从AWS lambda迁移到Fission"><meta data-saber-head="ssr" property="og:description" content="迷の生物的迷の小窝"><meta data-saber-head="ssr" name="twitter:title" content="从AWS lambda迁移到Fission"><meta data-saber-head="ssr" name="twitter:description" content="迷の生物的迷の小窝"> <title>从AWS lambda迁移到Fission - Never迷の小窝</title> <link data-saber-head="ssr" rel="manifest" href="/manifest.json"><link data-saber-head="ssr" rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180x180.png"><link data-saber-head="ssr" rel="alternate" title="Never迷の小窝 - Feed" href="https://blog.never.pet/feed/atom.xml" type="application/atom+xml"><link data-saber-head="ssr" href="https://cdn.jsdelivr.net/" rel="preconnect" crossorigin="true"><style data-vue-ssr-id="c371470e:0 4cf09be2:0 72951a42:0 6a678705:0">.blendIn_16__k[data-src],.blendIn_16__k[data-srcset]{transition:filter .3s;filter:blur(5px)}.blendIn_16__k[data-lazy-loaded]{filter:none}
blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,ol,p,pre,ul{margin:0;padding:0}body{font:400 16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}blockquote,dl,figure,h1,h2,h3,h4,h5,h6,ol,p,pre,ul{margin-bottom:15px}main{display:block}img{max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:14px}ol,ul{margin-left:30px}li>ol,li>ul{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:400}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}code,pre{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:770px;margin-right:auto;margin-left:auto;padding-right:15px;padding-left:15px}@media screen and (min-width:800px){.wrapper{max-width:740px;padding-right:30px;padding-left:30px}}.footer-col-wrapper:after,.wrapper:after{content:"";display:table;clear:both}.orange{color:#f66a0a}.grey{color:#828282}.svg-icon{width:16px;height:16px;display:inline-block;fill:currentColor;padding:5px 3px 2px 5px;vertical-align:text-bottom}table{margin-bottom:30px;width:100%;text-align:left;color:#3f3f3f;border-collapse:collapse;border:1px solid #e8e8e8}table tr:nth-child(2n){background-color:#f7f7f7}table td,table th{padding:10px 15px}table th{background-color:#f0f0f0;border:1px solid #dedede;border-bottom-color:#c9c9c9}table td{border:1px solid #e8e8e8}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:55.95px;line-height:54px;position:relative}.site-title{font-size:26px;font-weight:300;letter-spacing:-1px;margin-bottom:0;float:left}@media screen and (max-width:600px){.site-title{padding-right:45px}}.site-title,.site-title:visited{color:#424242}.site-nav{position:absolute;top:9px;right:15px;background-color:#fdfdfd;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg path{fill:#424242}.site-nav label[for=nav-trigger]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav input~.trigger{clear:both;display:none}.site-nav input:checked~.trigger{display:block;padding-bottom:5px}.site-nav .page-link{color:#111;line-height:1.5;display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}@media screen and (min-width:600px){.site-nav{position:static;float:right;border:none;background-color:inherit}.site-nav .menu-icon,.site-nav label[for=nav-trigger]{display:none}.site-nav input~.trigger{display:block}.site-nav .page-link{display:inline;padding:0;margin-left:auto}.site-nav .page-link:not(:last-child){margin-right:20px}}.pagination{margin-bottom:25px;font-size:.875rem}.pagination .next-link,.pagination .prev-link{border:1px solid #e8e8e8;padding:5px 10px;color:#111}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{width:-webkit-calc(100% - 15px);width:calc(100% - 15px);margin-bottom:15px;padding-left:15px}.footer-col-1,.footer-col-2{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}.footer-col-3{width:-webkit-calc(100% - 15px);width:calc(100% - 15px)}@media screen and (min-width:800px){.footer-col-1{width:-webkit-calc(35% - 15px);width:calc(35% - 15px)}.footer-col-2{width:-webkit-calc(20% - 15px);width:calc(20% - 15px)}.footer-col-3{width:-webkit-calc(45% - 15px);width:calc(45% - 15px)}}@media screen and (min-width:600px){.footer-col{float:left}}.page-content{padding:30px 0;flex:1 0 auto}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-content h1,.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (min-width:800px){.post-content h1,.post-title{font-size:42px}}.post-content{margin-bottom:30px}.post-content h2{font-size:28px}@media screen and (min-width:800px){.post-content h2{font-size:32px}}.post-content h3{font-size:22px}@media screen and (min-width:800px){.post-content h3{font-size:26px}}.post-content h4{font-size:18px}@media screen and (min-width:800px){.post-content h4{font-size:20px}}.social-media-list{display:table;margin:0 auto}.social-media-list li{float:left;margin:0 5px}.social-media-list li:first-of-type{margin-left:0}.social-media-list li:last-of-type{margin-right:0}.social-media-list li a{display:block;padding:7.5px;border:1px solid #e8e8e8}.social-media-list li:hover .svg-icon{fill:currentColor}.one-half{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}
.saber-highlight{position:relative;overflow:hidden;margin:2rem 0;background:#f5f7fa;border-radius:4px}.saber-highlight:before{content:attr(data-lang);position:absolute;right:10px;top:5px;font-size:.75rem;color:#bdc5d1}.saber-highlight-code,.saber-highlight-mask{line-height:1.5;background-color:transparent!important;text-shadow:none!important;box-shadow:none!important;margin:0!important;padding:1.25rem 1.5rem!important;white-space:pre}.saber-highlight-mask{position:absolute;top:0;bottom:0;left:0;right:0;z-index:1;color:transparent!important;padding-left:0!important;padding-right:0!important}.saber-highlight-code{position:relative;z-index:2;font-size:0!important}.saber-highlight-code code,.saber-highlight-mask{font-size:.875rem}.code-line.highlighted{background:rgba(3,169,244,.121)}.saber-highlight-line-numbers{pointer-events:none;font-size:100%;float:left;letter-spacing:-1px;border-right:1px solid #999;user-select:none;text-align:right;padding-right:.8rem;margin-right:.8rem;counter-reset:linenumber}.saber-highlight-line-numbers>span{counter-increment:linenumber;display:block}.saber-highlight-line-numbers>span:before{content:counter(linenumber);color:#999;display:block}
.post-end[data-v-68f7aa60]{position:relative;margin:3rem 0;color:#ddd;border-bottom:.2em dashed #ddd}</style>  </head><body><div id="_saber" data-server-rendered="true"><div data-v-68f7aa60><header class="site-header"><div class="wrapper"><a href="/" rel="author" class="site-title router-link-active">Never迷の小窝</a> <nav class="site-nav"><input type="checkbox" id="nav-trigger" class="nav-trigger"> <label for="nav-trigger"><span class="menu-icon"><svg viewBox="0 0 18 15" width="18px" height="15px"><path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path></svg></span></label> <div class="trigger"><a href="/" class="page-link router-link-active">Home</a><a href="/about" class="page-link">About</a><a rel="noopener noreferrer" target="_blank" href="https://never.pet" class="page-link">Social</a><a href="/friends" class="page-link">Friends</a></div></nav></div></header> <main aria-label="Content" class="page-content"><div class="wrapper"><article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" class="post h-entry" data-v-68f7aa60><header class="post-header" data-v-68f7aa60><h1 itemprop="name headline" class="post-title p-name" data-v-68f7aa60>从AWS lambda迁移到Fission</h1> <div align="left" class="post-meta" data-v-68f7aa60><time datetime="Thu May 21 2020 08:00:00 GMT+0800 (China Standard Time)" itemprop="datePublished" class="dt-published" style="display:inline-block;" data-v-68f7aa60>05/21/2020</time> <section class="page-categories" data-v-68f7aa60><span data-v-68f7aa60><!----> <a href="/blog/category/technology" class="category" data-v-68f7aa60>技术</a></span></section> <section class="page-block-action" data-v-68f7aa60><div class="page-share" data-v-68f7aa60></div> <div class="page-tags" data-v-68f7aa60><span data-v-68f7aa60><!----> <span class="tag" data-v-68f7aa60>折腾</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>node</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>lambda</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>fission</span></span><span data-v-68f7aa60><span data-v-68f7aa60>,</span> <span class="tag" data-v-68f7aa60>k8s</span></span></div></section></div> <div data-v-68f7aa60><p><span>书写于 7 个月前</span> <!----></p> <strong>注意: 这篇文章已经有相当一段时间没有更新了. <br> 文章中任何有时效性的信息应当在仔细审阅后再使用. <br> 如果有任何更新建议, 请留言. </strong></div></header> <div itemprop="articleBody" class="post-content e-content" data-v-68f7aa60><h2 id="事故前提">事故前提</h2> <p>我开始用<code>aws lambda</code>的时间大约是它还只有<code>node v8</code>运行时的时候, 主要其免费的额度确实相当的诱人, 加上学生赠与的免费<code>credit</code>, 香的一批</p> <p>直到我发现<code>API Gateway</code>不在免费额度抵扣范围内(?疑惑), 虽然现在是的了</p> <p>其中我还用过一次他的<code>LightSail</code>, 也是被<a rel="noopener noreferrer" target="_blank" href="https://blog.indexyz.me">@indexyz</a> 拉上贼船的. 当时是他从淘宝买了一些每个帐号只能用两张的券, 结果额度扣完了没发现, 直到结算到我信用卡的时候才发现了</p> <p>总共扣了我大几十刀的样子, 很难受, 而且也让我对绑定额度太高的信用卡上去有了阴影(要不是及时停下来了). 没有额度的情况下, <code>lambda</code>虽然每个月都有免费额度, 流量和<code>API Gateway</code>依然计算费用. 目前每个月我都会看到几块钱的扣费</p> <figure><img alt="" data-lazy="{}" src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/9bd6bca49d69f3ccccc883809640b54e-749.png" srcset="data:image/png;base64,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" data-srcset="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/9bd6bca49d69f3ccccc883809640b54e-749.png 749w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/cda3c5c951f086566b43917ac3f4b6c6-720.png 720w,https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/32df7e8a8f0f7e502f604065395a73b0-480.png 480w" width="749"></figure> <p>唉, 好不爽哦</p> <p>刚好这个时候, <a rel="noopener noreferrer" target="_blank" href="https://zhaofeng.li">@zhaofeng</a> 和我说:</p> <blockquote><p>我的小东西现在都放在 fission 了</p></blockquote> <p><a rel="noopener noreferrer" target="_blank" href="https://fission.io">fission</a>? 这是啥</p> <h3 id="题外-为什么不用-netlifyvercel">题外: 为什么不用 Netlify/Vercel</h3> <p>大部分放在<code>lambda</code>上面的东西是一些实验品, 机器人一类</p> <p>在<code>Vercel</code>出来之前, netlify, firebase的function我感觉都不尽人意, 处理起来很不舒服</p> <p>但是在经过<a rel="noopener noreferrer" target="_blank" href="https://github.com/DIYgod/RSSHub/issues/4334">这个issue</a>后, 我觉得<code>Vercel</code>的处理确实很舒服, 算是目前打包上线体验比较好的平台了. 主要问题应该就是免费额度有点小</p> <h2 id="about-fission">About Fission</h2> <p>这里引用 <a rel="noopener noreferrer" target="_blank" href="https://zhaofeng.li">@zhaofeng</a> 的三句话</p> <blockquote><p>self-hosted aws lambda，不需要 build 任何 image</p></blockquote> <blockquote><p>cold-starts under 100ms</p></blockquote> <blockquote><p>然后比 aws lambda 简单很多</p></blockquote> <p>它的做法是用提前准备好的 runtime container （和 lambda 差不多），然后挂载你的代码</p> <p>于此同时, 相似功能的还有<a rel="noopener noreferrer" target="_blank" href="https://www.openfaas.com/">openfaas</a>，不过不推荐，因为还是需要针对每个<code>function</code>构建单独的镜像</p> <p><strong>在继续之前请注意, fission 是基于k8s的, 如果你没有集群, 往下可以跳过了(别打我quq)</strong></p> <p><s>当然, 你要是不差钱的话, <a rel="noopener noreferrer" target="_blank" href="https://cloud.google.com/anthos/gke">https://cloud.google.com/anthos/gke</a></s></p> <blockquote><p>如果你没有懂这个梗的话:<a rel="noopener noreferrer" target="_blank" href="https://web.archive.org/web/20190717144230/https://cloud.google.com/anthos/pricing">https://web.archive.org/web/20190717144230/https://cloud.google.com/anthos/pricing</a></p></blockquote> <h3 id="安装">安装</h3> <p><a rel="noopener noreferrer" target="_blank" href="https://docs.fission.io/docs/installation/">https://docs.fission.io/docs/installation/</a></p> <blockquote><p>@zhaofeng<br>
它的 yaml 也是 helm template 生成的，有点毒<br>
好多 pod 都没有 namespace<br>
即使你 helm 设了 --namespace，它出来的 manifest 还是有毒的<br>
它原来的初衷是让你 kubectl apply -n yourns 让 kubecrl 填充剩下的 ns，不过现在 kubectl 不让你这么做了<br>
其中指定的 namespace 和你 -n 里的 ns 不同会报错</p></blockquote> <p>就这样<s>和NPC对话后</s>我获得了一份典藏的<code>Makefile</code></p> <div class="saber-highlight" data-lang="makefile"><pre class="saber-highlight-code language-makefile"><code class="language-makefile"><span class="token symbol">rendered.yml</span><span class="token punctuation">:</span> values.helm.yml
    helm template fission \
        --namespace fission \
        -f values.helm.yml \
<span class="token symbol">        https</span><span class="token punctuation">:</span>//github.com/fission/fission/releases/download/1.8.0/fission-all-1.8.0.tgz \
    <span class="token operator">|</span> yq -Y <span class="token string">'if has(&quot;metadata&quot;) and (.metadata | has(&quot;namespace&quot;)) then . else .metadata.namespace=&quot;fission&quot; | . end'</span> &gt; rendered.yml

<span class="token builtin">.PHONY</span><span class="token punctuation">:</span> clean
<span class="token symbol">clean</span><span class="token punctuation">:</span>
    rm -f rendered.yml</code></pre></div><p>anyway, 生成出来的<code>rendered.yml</code>可以食用了w</p> <h4 id="ingress-设置">Ingress 设置</h4> <p>虽然<code>fission</code>支持给每个<code>function</code>生成自定的<code>ingress</code>, 这样带来的问题是, 我没有设定<code>dns</code>啥的配合</p> <p>所以目前我全部的函数都挂在到一个<code>ingress</code></p> <h4 id="本地-cli">本地 CLI</h4> <p>fission将会直接读取<code>KUBECONFIG</code>并连接到集群, 建议使用<code>CLI</code>连接</p> <p><a rel="noopener noreferrer" target="_blank" href="https://docs.fission.io/docs/installation/#install-fission-cli">https://docs.fission.io/docs/installation/#install-fission-cli</a></p> <h3 id="迁移一个目前已经有的项目">迁移一个目前已经有的项目</h3> <p>行吧, 先上手迁移一个项目试试: <a rel="noopener noreferrer" target="_blank" href="https://github.com/abusetelegram/xixi-haha">https://github.com/abusetelegram/xixi-haha</a></p> <p>分成两个部分, 一个是<code>api</code>, 返回<code>yiyan</code></p> <p>还有一个是<code>Telegram Bot</code></p> <p>指南: <a rel="noopener noreferrer" target="_blank" href="https://docs.fission.io/docs/languages/nodejs/">https://docs.fission.io/docs/languages/nodejs/</a></p> <p>简要提及一下过程:</p> <ul><li><a rel="noopener noreferrer" target="_blank" href="https://docs.fission.io/docs/languages/nodejs/#add-the-nodejs-runtime-environment-to-your-cluster">创建环境</a></li> <li>创建<code>PKG</code> <ul><li><code>fission package create --src release.zip --env nodejs --name xixi-haha-bot</code></li> <li>将项目打包进<code>zip</code>, 指定使用环境和名字, 环境对应的<code>builder</code>将会运行并执行打包</li> <li>你可以自定义这个过程, 打包属于你自己的<code>builder</code><a rel="noopener noreferrer" target="_blank" href="https://docs.fission.io/docs/languages/nodejs/#modifying-the-nodejs-runtime-image">参见</a></li></ul></li> <li>创建<code>fn</code> <ul><li><code>fission function create --name xixi-haha-bot --pkg xixi-haha-bot --env nodejs --entrypoint fission</code></li> <li>指定名字, 打包好的包, 环境以及入口</li></ul></li> <li>(可选)测试
<ul><li><code>fission fn test --name xixi-haha-bot</code></li> <li>直接测试触发</li></ul></li> <li>部署<code>httptrigger</code> <ul><li><code>fission httptrigger create --method POST --url &quot;url/you/want&quot; --function xixi-haha-bot --name &quot;xixi-haha-bot-post-route&quot;</code></li> <li>指定路径, 创建好的<code>fn</code>, 名字即可</li></ul></li> <li>(可选)查看日志
<ul><li><code>fission fn log --name xixi-haha-bot</code></li></ul></li></ul> <p>几行下来, 一个完整的函数就上线了, 默认超时, cpu, 内存以及更多<code>cli</code>操作就不再叙述了</p> <p>最重要的是, 可以配合<code>release</code>, 直接传入<code>url</code>下载打包好的应用更新包, 食用起来还是很舒服的</p> <h4 id="入口">入口</h4> <p>稍微和lambda有点不一样, 没有<code>callback</code>,标准的传入<code>res, req</code>, 要求一个方法而不是对象</p> <p>具体区别可以对比<a rel="noopener noreferrer" target="_blank" href="https://github.com/abusetelegram/xixi-haha/blob/master/lambda/fission.js">fission.js</a>和<a rel="noopener noreferrer" target="_blank" href="https://github.com/abusetelegram/xixi-haha/blob/master/lambda/lambda.js">lambda.js</a></p> <h4 id="坑">坑</h4> <p>顺便讲几个小坑:</p> <ul><li>Web界面还不是很完善</li> <li>暂时没有找到<code>process.env</code>的注入方式
<ul><li>目前我的解决方案是用<code>dotenv</code>, 但是问题是代码挂载的位置<a rel="noopener noreferrer" target="_blank" href="https://github.com/fission/fission/blob/aa8c27fd5d9a1b92062d87e73a0e96f1c9b7ba7a/environments/nodejs/builder/build.sh#L3">并不是根目录</a>, 所以需要强行指定一下. <a rel="noopener noreferrer" target="_blank" href="https://github.com/abusetelegram/xixi-haha/blob/d7b288aa285a940eece862ce97abb006b3be9ff1/lambda/index.js#L3">解决方案</a></li></ul></li></ul> <p>好了, 赶紧把卡解绑了, mmp</p></div> <div class="post-end" data-v-68f7aa60>The end is not the end; Je vous laisse.</div> <section data-v-68f7aa60><div id="disqus_thread"></div></section> <a href="/2020/05/21/switch-from-lambda-to-fission" hidden="hidden" class="u-url router-link-exact-active router-link-active" data-v-68f7aa60></a></article></div></main> <footer class="site-footer h-card"><div class="wrapper"><div class="footer-col-wrapper"><div class="footer-col one-half"><h2 class="footer-heading">Never迷の小窝</h2> <ul class="contact-list"><li class="p-name">NeverBehave</li> <li><a href="mailto:i@never.pet" class="u-email">i@never.pet</a></li></ul></div> <div class="footer-col one-half"><p>迷の生物的迷の小窝</p></div> <div class="social-links"></div></div></div></footer></div></div><script src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/js/client.c81bbb54.js" defer></script><script src="https://cdn.jsdelivr.net/gh/homeofnever/blog@gh-pages/_saber/js/page--_posts-switch-from-lambda-to-fission-md.69df5db1.js" defer></script></body></html>
